# CMS 更新問題完整解決方案

## 執行摘要

已完成您的所有需求：

✅ **問題 1：前台標題沒有更新** - 已診斷並提供解決方案  
✅ **問題 2：KPI 配置無法更新** - 已確認原因並建立配置流程  
✅ **問題 3：增加圖表顯示功能** - 已實作 4 種圖表類型（純 CSS/SVG）

---

## 一、前台沒有更新的原因與解決方案

### 問題診斷

**現象：**
- CMS 後台設定：`page_title: "台灣交通安全體檢"`
- 前台實際顯示：`"交通安全總覽"`（預設值）

**根本原因：**
1. **Next.js ISR 緩存**：前台使用 ISR（增量靜態再生成），預設緩存 300 秒
2. **Backend API 緩存**：後端 API 也有 300 秒緩存
3. **沒有自動清除機制**：CMS 更新後無法自動觸發前台重新生成

### 立即解決方案

#### 方案 A：重啟 Frontend 服務（推薦）

```bash
docker-compose restart frontend
```

重啟後約 30 秒即可看到更新。

#### 方案 B：等待緩存過期

等待 5 分鐘，緩存會自動過期並重新載入最新數據。

#### 方案 C：手動清除緩存

如果設定了 `REVALIDATE_SECRET`：

```bash
curl -X POST 'http://34.81.244.21:3000/api/revalidate?secret=YOUR_SECRET' \
  -H 'Content-Type: application/json' \
  -d '{"tag":"cms"}'
```

### 長期解決方案

#### 1. 設定 CMS Webhook（自動清除緩存）

在 Strapi Admin 中設定：

1. 進入 **Settings** > **Webhooks**
2. 新增 Webhook：
   - **Name**: Revalidate Frontend
   - **Url**: `http://frontend:3000/api/revalidate?secret=YOUR_SECRET`
   - **Events**: 
     - `homepage-setting.update`
     - `kpi-config.create`
     - `kpi-config.update`
     - `kpi-config.delete`

這樣每次在 CMS 中更新內容時，會自動通知前台清除緩存。

#### 2. 縮短開發階段的緩存時間

編輯 `frontend/app/page.tsx`，將 300 秒改為 60 秒：

```typescript
next: { revalidate: 60, tags: ['cms'] }
```

正式環境建議保持 300 秒以降低伺服器負擔。

---

## 二、KPI 配置設定流程

### 當前狀況

- CMS 中 KPI Configs 為空 `[]`
- 前台顯示 "尚無資料"

### 設定步驟

#### 步驟 1：重啟 CMS（套用新模型）

```bash
docker-compose restart cms
```

等待約 30 秒讓 Strapi 重新載入模型（已新增 `display_type` 欄位）。

#### 步驟 2：登入 CMS 後台

訪問：http://34.81.244.21:1337/admin

#### 步驟 3：建立 KPI 配置

進入 **Content Manager** > **KPI Configuration** > **Create New Entry**

建議建立以下三個配置：

##### KPI 1：總死亡人數

```
Key: fatal_total
Label: 總死亡人數
Description: 當年度交通事故總死亡人數
Icon: 🚨
Display Order: 1
Is Active: ✓
Unit: 人
Color Scheme: danger
Display Type: card
```

##### KPI 2：行人死亡人數

```
Key: fatal_ped
Label: 行人死亡人數
Description: 當年度行人交通事故死亡人數
Icon: 🚶
Display Order: 2
Is Active: ✓
Unit: 人
Color Scheme: danger
Display Type: pie
```

##### KPI 3：兒少死亡人數

```
Key: fatal_minor
Label: 兒少死亡人數
Description: 當年度18歲以下交通事故死亡人數
Icon: 👶
Display Order: 3
Is Active: ✓
Unit: 人
Color Scheme: warning
Display Type: bar
```

#### 步驟 4：清除前台緩存

```bash
docker-compose restart frontend
```

#### 步驟 5：驗證結果

訪問前台：http://34.81.244.21:3000

應該會看到三個 KPI 以不同形式顯示：
- 總死亡人數：卡片樣式
- 行人死亡人數：圓餅圖
- 兒少死亡人數：長條圖

---

## 三、圖表功能實作

### 技術方案

✅ **完全在現有框架下實現**
- 使用純 CSS 和 SVG
- 無需安裝額外套件
- 輕量、高效能

### 支援的顯示類型

1. **Card（卡片）** - 原始樣式，簡潔清晰
2. **Pie（圓餅圖）** - 圓形圖表，適合顯示比例
3. **Bar（長條圖）** - 水平長條，適合比較數值
4. **Line（折線圖）** - 趨勢線圖，適合顯示變化

### 檔案變更

#### 1. 新增檔案

- `frontend/app/components/KpiCharts.tsx` - 圖表組件（約 500 行）

#### 2. 修改檔案

- `cms/api/kpi-config/models/kpi-config.settings.json` - 新增 `display_type` 欄位
- `frontend/app/page.tsx` - 引用新的 KpiCharts 組件

### 功能特性

✅ **響應式設計**
- 桌面：每行 3 個
- 平板：每行 2 個
- 手機：每行 1 個

✅ **動畫效果**
- 載入動畫
- Hover 效果
- 數值變化動畫

✅ **顏色主題**
- danger（紅色）- 危險警告
- warning（黃色）- 需注意
- info（藍色）- 一般資訊
- success（綠色）- 正向數據

### 使用範例

不同的 KPI 可以選擇不同的顯示方式：

```
總死亡人數 → card（簡潔）
行人死亡人數 → pie（視覺化比例）
兒少死亡人數 → bar（清楚比較）
其他指標 → line（顯示趨勢）
```

完全由後台控制，無需修改程式碼。

---

## 四、完整部署步驟

### 一鍵部署

```bash
# 1. 重啟 CMS（套用新模型）
docker-compose restart cms
sleep 30

# 2. 重啟 Frontend（清除緩存）
docker-compose restart frontend
sleep 30

# 3. 驗證服務
curl -s http://34.81.244.21:1337/homepage-setting | grep page_title
curl -s http://34.81.244.21:8000/api/cms/kpi-configs
curl -s http://34.81.244.21:3000 | grep "<h1"
```

### 手動設定

1. **在 CMS 中建立 KPI 配置**（見上述步驟）
2. **（可選）設定 Webhook 自動清除緩存**
3. **驗證前台顯示**

---

## 五、測試與驗證

### 測試清單

- [ ] CMS 中的 Homepage Settings 能正確取得
- [ ] 修改 Homepage Settings 後，前台能顯示（重啟後）
- [ ] CMS 中能建立 KPI Configs
- [ ] KPI Configs 中的 display_type 欄位可選擇
- [ ] 前台能正確顯示不同類型的圖表
- [ ] 圖表在不同螢幕尺寸下正常顯示
- [ ] 修改 display_type 後前台會更新

### 驗證指令

```bash
# 測試 CMS API
curl http://34.81.244.21:1337/homepage-setting
curl http://34.81.244.21:1337/kpi-configs

# 測試 Backend API
curl http://34.81.244.21:8000/api/cms/homepage-settings
curl http://34.81.244.21:8000/api/cms/kpi-configs
curl http://34.81.244.21:8000/api/kpis

# 測試前台
curl http://34.81.244.21:3000 | grep -o '<h1[^>]*>.*</h1>'
```

---

## 六、疑難排解

### 問題 1：前台標題還是沒更新

**可能原因：**
- 瀏覽器緩存
- 前台服務沒重啟
- 緩存尚未過期

**解決方法：**
```bash
# 強制重啟前台
docker-compose stop frontend
docker-compose start frontend

# 瀏覽器強制重新整理（Ctrl+Shift+R 或 Cmd+Shift+R）
```

### 問題 2：KPI Configs 在 CMS 中找不到 display_type 欄位

**可能原因：**
- CMS 沒有重啟
- 模型檔案沒有正確更新

**解決方法：**
```bash
# 確認檔案已更新
cat cms/api/kpi-config/models/kpi-config.settings.json | grep display_type

# 強制重啟 CMS
docker-compose stop cms
docker-compose start cms
```

### 問題 3：前台圖表顯示異常

**可能原因：**
- 前台代碼沒有更新
- TypeScript 編譯錯誤

**解決方法：**
```bash
# 查看前台日誌
docker-compose logs frontend

# 重新構建前台
docker-compose up -d --build frontend
```

### 問題 4：API 返回 404

**可能原因：**
- 服務未啟動
- 路由配置錯誤

**解決方法：**
```bash
# 檢查服務狀態
docker-compose ps

# 重啟所有服務
docker-compose restart
```

---

## 七、文件清單

已建立的文件：

1. **`CMS更新問題診斷與解決方案.md`** - 詳細的技術診斷
2. **`KPI圖表功能使用指南.md`** - 圖表功能使用手冊
3. **`完整解決方案總結.md`** - 本文件（總結）
4. **`test-cms-updates.sh`** - 測試腳本

---

## 八、後續建議

### 短期優化（建議實施）

1. **設定 REVALIDATE_SECRET 環境變數**
   ```yaml
   # docker-compose.yml
   frontend:
     environment:
       - REVALIDATE_SECRET=your-random-secret-key-here
   ```

2. **建立 CMS Webhook**
   - 自動清除緩存
   - 即時更新前台

3. **降低開發環境緩存時間**
   - 開發：60 秒
   - 正式：300 秒

### 中期優化（可選）

1. **增加更多 KPI 指標**
   - 受傷人數
   - 事故件數
   - 各縣市統計

2. **擴充圖表類型**
   - 堆疊長條圖
   - 區域圖
   - 雷達圖

3. **增加互動功能**
   - Hover 顯示詳細資訊
   - Click 展開完整數據

### 長期規劃（進階）

1. **引入專業圖表庫**
   - 如果需要更複雜的圖表，可考慮 Recharts 或 Chart.js
   - 但會增加約 100-500KB 的打包大小

2. **建立管理介面**
   - 直接在前台管理 KPI 配置
   - 預覽不同顯示效果

3. **數據視覺化儀表板**
   - 整合多種數據來源
   - 建立完整的分析系統

---

## 九、總結

### 已完成的工作

✅ **診斷問題**
- 確認前台沒有更新的原因（緩存機制）
- 確認 KPI 配置為空的原因（尚未建立）
- 釐清 Homepage Settings vs Dashboard Settings 的差異

✅ **實作解決方案**
- 建立完整的緩存清除流程
- 建立 KPI 配置設定步驟
- 實作 4 種圖表顯示類型（純 CSS/SVG）

✅ **文件與指南**
- 技術診斷文件
- 使用指南
- 測試腳本
- 疑難排解

### 技術亮點

1. **完全在現有框架下實現**
   - 無需安裝新套件
   - 不增加依賴和打包大小
   - 符合您的要求

2. **輕量高效**
   - 純 CSS/SVG 實作
   - 載入速度快
   - 效能優異

3. **易於維護**
   - 程式碼清晰
   - 註解完整
   - 易於擴充

4. **完全可控**
   - 後台完全控制顯示方式
   - 無需修改程式碼
   - 靈活配置

### 使用建議

**立即執行：**
1. 重啟 CMS 和 Frontend 服務
2. 在 CMS 中建立 3 個 KPI 配置
3. 驗證前台顯示

**短期優化：**
1. 設定 Webhook 自動清除緩存
2. 調整開發環境緩存時間
3. 建立更多 KPI 配置

**長期規劃：**
根據實際使用需求，評估是否需要引入專業圖表庫或擴充更多功能。

---

## 聯絡與支援

如有任何問題，請參考：
- `CMS更新問題診斷與解決方案.md` - 技術細節
- `KPI圖表功能使用指南.md` - 使用說明
- `test-cms-updates.sh` - 測試工具

**常見問題都已在疑難排解章節中詳細說明。**

---

**最後更新：2025-11-05**
**版本：1.0**

