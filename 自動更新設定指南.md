# 自動更新設定指南 - 無需重啟系統

## 目標

讓您在 CMS 後台修改內容後，前台能**自動更新**，無需手動重啟服務。

---

## 方案總覽

我們提供三個方案，可以單獨或組合使用：

| 方案 | 更新速度 | 難易度 | 建議 |
|------|---------|--------|------|
| 方案一：Webhook 自動觸發 | 即時（幾秒內） | ⭐⭐⭐ | ✅ 強烈推薦 |
| 方案二：縮短緩存時間 | 30-60秒 | ⭐ | ✅ 搭配方案一 |
| 方案三：手動刷新按鈕 | 即時 | ⭐⭐ | 適合開發階段 |

**最佳組合：方案一 + 方案二**

---

## 方案一：Webhook 自動觸發（強烈推薦）

### 原理

當您在 CMS 中儲存內容時，Strapi 會自動發送通知到 Frontend，觸發緩存清除。

```
CMS 更新內容 → Webhook 通知 → Frontend 清除緩存 → 用戶看到新內容
```

### 步驟 1：設定 REVALIDATE_SECRET

首先需要設定一個密鑰來保護 revalidate API。

#### 1.1 生成隨機密鑰

```bash
# 生成一個安全的隨機密鑰
openssl rand -base64 32
```

會得到類似：`abc123XYZ789...` 的字串，複製它。

#### 1.2 更新 docker-compose.yml

編輯 `docker-compose.yml`，在 frontend 服務中新增環境變數：

```yaml
services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_BASE=http://backend:8000/api
      - NEXT_PUBLIC_CMS_BASE=http://cms:1337
      - REVALIDATE_SECRET=YOUR_SECRET_KEY_HERE  # 👈 新增這行，替換成剛才生成的密鑰
    depends_on:
      - backend
      - cms
    networks:
      - app-network
```

#### 1.3 重啟 Frontend（只需要這一次）

```bash
docker-compose up -d frontend
```

### 步驟 2：在 Strapi 中設定 Webhook

#### 2.1 登入 Strapi Admin

訪問：http://34.81.244.21:1337/admin

#### 2.2 進入 Webhooks 設定

1. 點擊左側選單：**Settings**（設定）
2. 找到 **GLOBAL SETTINGS** 區塊
3. 點擊：**Webhooks**

#### 2.3 新增 Webhook - Homepage Settings

點擊 **Add new webhook**，填寫：

**基本設定：**
- **Name**（名稱）：`Revalidate Homepage`
- **Url**：`http://frontend:3000/api/revalidate?secret=YOUR_SECRET_KEY_HERE`
  - ⚠️ 將 `YOUR_SECRET_KEY_HERE` 替換成您在步驟 1.2 設定的密鑰
- **Headers**（可選）：
  ```
  Content-Type: application/json
  ```

**Events**（事件）- 勾選以下項目：
- ✓ **Entry**
  - ✓ Create
  - ✓ Update
  - ✓ Delete

**Filters**（篩選）：
- Content Type: `homepage-setting`

點擊 **Save** 儲存。

#### 2.4 新增 Webhook - KPI Configs

再次點擊 **Add new webhook**：

**基本設定：**
- **Name**：`Revalidate KPI Configs`
- **Url**：`http://frontend:3000/api/revalidate?secret=YOUR_SECRET_KEY_HERE`
- **Headers**：
  ```
  Content-Type: application/json
  ```

**Events**：
- ✓ **Entry**
  - ✓ Create
  - ✓ Update
  - ✓ Delete

**Filters**：
- Content Type: `kpi-config`

點擊 **Save**。

#### 2.5 新增 Webhook - Dashboard Settings

第三個 Webhook：

**基本設定：**
- **Name**：`Revalidate Dashboard`
- **Url**：`http://frontend:3000/api/revalidate?secret=YOUR_SECRET_KEY_HERE`

**Events**：
- ✓ **Entry** (全選)

**Filters**：
- Content Type: `dashboard-setting`

點擊 **Save**。

#### 2.6 測試 Webhook

在每個 Webhook 的右側，點擊 **Trigger** 按鈕測試。

**成功的回應：**
```json
{
  "revalidated": true,
  "now": 1699200000000
}
```

如果看到 `401 Unauthorized`，表示密鑰不正確。

---

## 方案二：縮短緩存時間

### 原理

即使沒有 Webhook，緩存過期後也會自動更新。縮短緩存時間可以更快看到更新。

### 修改 Frontend 緩存設定

編輯 `frontend/app/page.tsx`：

```typescript
// 找到所有的 fetch 呼叫，將 revalidate 從 300 改為 60

async function getKpis() {
  const base = process.env.NEXT_PUBLIC_API_BASE || 'http://backend:8000/api'
  try {
    const res = await fetch(`${base}/kpis?baseline_year=2020&period=year:2024`, {
      next: { revalidate: 60, tags: ['kpis'] },  // 👈 從 300 改為 60
    })
    // ...
  }
}

async function getHomepageSettings() {
  const base = process.env.NEXT_PUBLIC_API_BASE || 'http://backend:8000/api'
  try {
    const res = await fetch(`${base}/cms/homepage-settings`, {
      next: { revalidate: 60, tags: ['cms'] },  // 👈 從 300 改為 60
    })
    // ...
  }
}

async function getKpiConfigs() {
  const base = process.env.NEXT_PUBLIC_API_BASE || 'http://backend:8000/api'
  try {
    const res = await fetch(`${base}/cms/kpi-configs`, {
      next: { revalidate: 60, tags: ['cms'] },  // 👈 從 300 改為 60
    })
    // ...
  }
}

async function getTopSegments() {
  const base = process.env.NEXT_PUBLIC_API_BASE || 'http://backend:8000/api'
  try {
    const res = await fetch(`${base}/segments/top?county=ALL&limit=5&year=2024`, {
      next: { revalidate: 60, tags: ['segments'] },  // 👈 從 300 改為 60
    })
    // ...
  }
}

async function getLatestPosts() {
  const base = getCmsBaseUrl()
  try {
    const res = await fetch(`${base}/posts?_sort=published_at:DESC&_limit=3`, {
      next: { revalidate: 60, tags: ['blog'] },  // 👈 從 300 改為 60
    })
    // ...
  }
}
```

### 修改 Backend 緩存設定

編輯 `backend/app/routers/cms_content.py`：

```python
# 找到所有的 @cache_result 裝飾器，將 ttl 從 300 改為 60

@cache_result("homepage_settings", ttl=60)  # 👈 從 300 改為 60
async def fetch_homepage_settings():
    # ...

@cache_result("dashboard_settings", ttl=60)  # 👈 從 300 改為 60
async def fetch_dashboard_settings():
    # ...

@cache_result("kpi_configs", ttl=60)  # 👈 從 300 改為 60
async def fetch_kpi_configs():
    # ...
```

### 重新構建服務（只需這一次）

```bash
docker-compose up -d --build frontend backend
```

**效果：**
- 修改後最多等待 60 秒就會自動更新
- 結合 Webhook 可以做到即時更新

---

## 方案三：手動刷新按鈕（開發階段）

### 原理

在前台或管理界面加入一個「刷新」按鈕，點擊後立即清除緩存。

### 建立管理工具頁面

創建 `frontend/app/admin/page.tsx`：

```typescript
'use client'

import { useState } from 'react'

export default function AdminPage() {
  const [loading, setLoading] = useState(false)
  const [message, setMessage] = useState('')

  const handleRevalidate = async (tag: string) => {
    setLoading(true)
    setMessage('')
    
    try {
      const secret = prompt('請輸入 REVALIDATE_SECRET:')
      if (!secret) return
      
      const res = await fetch(`/api/revalidate?secret=${secret}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tag })
      })
      
      if (res.ok) {
        setMessage(`✅ 成功刷新 ${tag} 緩存！`)
      } else {
        setMessage(`❌ 刷新失敗：${res.status}`)
      }
    } catch (error) {
      setMessage(`❌ 錯誤：${error}`)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div style={{ maxWidth: '600px', margin: '2rem auto', padding: '2rem' }}>
      <h1 style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '1rem' }}>
        緩存管理
      </h1>
      
      <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
        <button
          onClick={() => handleRevalidate('cms')}
          disabled={loading}
          style={{
            padding: '0.75rem 1.5rem',
            background: '#3b82f6',
            color: 'white',
            border: 'none',
            borderRadius: '0.375rem',
            cursor: loading ? 'not-allowed' : 'pointer',
            fontSize: '1rem'
          }}
        >
          刷新 CMS 內容緩存
        </button>
        
        <button
          onClick={() => handleRevalidate('kpis')}
          disabled={loading}
          style={{
            padding: '0.75rem 1.5rem',
            background: '#10b981',
            color: 'white',
            border: 'none',
            borderRadius: '0.375rem',
            cursor: loading ? 'not-allowed' : 'pointer',
            fontSize: '1rem'
          }}
        >
          刷新 KPI 數據緩存
        </button>
        
        <button
          onClick={() => handleRevalidate('blog')}
          disabled={loading}
          style={{
            padding: '0.75rem 1.5rem',
            background: '#f59e0b',
            color: 'white',
            border: 'none',
            borderRadius: '0.375rem',
            cursor: loading ? 'not-allowed' : 'pointer',
            fontSize: '1rem'
          }}
        >
          刷新部落格緩存
        </button>
      </div>
      
      {message && (
        <div style={{
          marginTop: '1rem',
          padding: '1rem',
          background: message.includes('✅') ? '#d1fae5' : '#fee2e2',
          borderRadius: '0.375rem'
        }}>
          {message}
        </div>
      )}
    </div>
  )
}
```

**使用方式：**
訪問 http://34.81.244.21:3000/admin，點擊按鈕即可刷新緩存。

---

## 完整設定流程（推薦）

### 一次性設定（約 10-15 分鐘）

```bash
# 1. 生成密鑰
openssl rand -base64 32

# 2. 更新 docker-compose.yml
# （加入 REVALIDATE_SECRET 環境變數）

# 3. 縮短緩存時間（可選但建議）
# 編輯 frontend/app/page.tsx
# 編輯 backend/app/routers/cms_content.py

# 4. 重新構建服務
docker-compose up -d --build

# 5. 在 Strapi 中設定 3 個 Webhooks
# （參考上面的詳細步驟）
```

### 日常使用

設定完成後，您只需要：

1. 登入 CMS：http://34.81.244.21:1337/admin
2. 修改內容（標題、KPI 配置等）
3. 點擊 **Save**
4. **🎉 完成！** 前台會在幾秒內自動更新

**無需重啟任何服務！**

---

## 驗證設定是否成功

### 測試步驟

1. **修改標題**
   - 進入 CMS > Homepage Setting
   - 修改 `page_title`
   - 儲存

2. **等待幾秒**
   - 如果有設定 Webhook：約 3-5 秒
   - 如果只有縮短緩存：最多 60 秒

3. **重新整理前台**
   - 訪問 http://34.81.244.21:3000
   - 按 F5 重新整理
   - 應該會看到新標題

### 檢查 Webhook 日誌

在 Strapi Admin > Settings > Webhooks，點擊 Webhook 名稱，可以看到：
- 觸發歷史
- 成功/失敗狀態
- 回應內容

---

## 疑難排解

### 問題：Webhook 測試失敗（401 Unauthorized）

**原因：** REVALIDATE_SECRET 不正確或未設定

**解決：**
```bash
# 1. 檢查環境變數
docker-compose exec frontend env | grep REVALIDATE

# 2. 確認 docker-compose.yml 中有設定
grep REVALIDATE docker-compose.yml

# 3. 確保 Webhook URL 中的 secret 參數正確
```

### 問題：Webhook 測試失敗（連線逾時）

**原因：** Frontend 服務無法從 CMS 訪問

**解決：**
```bash
# 測試網路連線
docker-compose exec cms curl http://frontend:3000/api/revalidate

# 確認服務在同一個 network
docker-compose ps
```

### 問題：修改後還是沒更新

**檢查清單：**
1. ✓ Webhook 是否設定正確？
2. ✓ Webhook 測試是否成功？
3. ✓ 瀏覽器是否強制重新整理（Ctrl+Shift+R）？
4. ✓ 是否等待足夠時間（60 秒）？

**強制刷新：**
```bash
# 手動呼叫 revalidate API
curl -X POST 'http://34.81.244.21:3000/api/revalidate?secret=YOUR_SECRET' \
  -H 'Content-Type: application/json' \
  -d '{"tag":"cms"}'
```

---

## 效能考量

### 緩存時間建議

| 環境 | 建議時間 | 說明 |
|------|---------|------|
| 開發環境 | 30-60 秒 | 更新快速，方便測試 |
| 正式環境 | 60-180 秒 | 平衡更新速度與伺服器負擔 |
| 高流量 | 180-300 秒 | 減少伺服器負擔 |

### 搭配 Webhook 的最佳實踐

如果有設定 Webhook：
- **緩存時間可以設長一點**（180-300 秒）
- **日常更新由 Webhook 觸發**（即時）
- **緩存作為備援機制**（萬一 Webhook 失敗）

---

## 總結

### 方案比較

| 項目 | 無設定 | 只縮短緩存 | 只 Webhook | Webhook + 緩存 |
|------|--------|-----------|-----------|---------------|
| 更新速度 | 5 分鐘 | 60 秒 | 3-5 秒 | 3-5 秒 |
| 需重啟 | ✓ | ✗ | ✗ | ✗ |
| 設定難度 | - | ⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| 伺服器負擔 | 低 | 中 | 低 | 低 |
| 可靠性 | - | 中 | 高 | 極高 |

### ✅ 最佳方案

**Webhook + 適度縮短緩存（60-180 秒）**

**優點：**
- ✅ 即時更新（3-5 秒）
- ✅ 無需重啟服務
- ✅ 自動化
- ✅ 可靠（有備援機制）
- ✅ 伺服器負擔低

**一次性設定 10-15 分鐘，終身受益！**

---

**下一步：執行設定腳本**

我已經準備好自動化設定腳本，請看下一個檔案！

